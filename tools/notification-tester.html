<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <title>Notification Tester</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 1.5rem;
      }
      textarea {
        width: 100%;
        min-height: 4rem;
      }
      pre {
        background: #111;
        color: #0f0;
        padding: 1rem;
        min-height: 300px;
        overflow: auto;
      }
      .status {
        margin: 0.5rem 0 1rem;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <h1>Realtime Notification Tester</h1>
    <p>D√°n JWT (access token) c·ªßa ng∆∞·ªùi nh·∫≠n v√†o √¥ d∆∞·ªõi r·ªìi b·∫•m k·∫øt n·ªëi.</p>
    <label for="token">JWT:</label>
    <textarea id="token" placeholder="eyJhbGciOi..."></textarea>
    <br />
    <label>
      Hub URL:
      <input id="hubUrl" type="text" value="https://localhost:7125/hubs/notifications" style="width: 100%;" />
    </label>
    <div class="status" id="status">Ch∆∞a k·∫øt n·ªëi</div>
    <button id="connectBtn">K·∫øt n·ªëi</button>
    <button id="disconnectBtn" disabled>Ng·∫Øt k·∫øt n·ªëi</button>
    <h2>Log</h2>
    <pre id="log"></pre>

    <script>
      const statusEl = document.getElementById("status");
      const logEl = document.getElementById("log");
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");

      let connection = null;

      const log = (message) => {
        const timestamp = new Date().toLocaleTimeString();
        logEl.textContent += `[${timestamp}] ${message}\n`;
        logEl.scrollTop = logEl.scrollHeight;
      };

      const setStatus = (text, isError = false) => {
        statusEl.textContent = text;
        statusEl.style.color = isError ? "#c00" : "#0a0";
      };

      connectBtn.addEventListener("click", async () => {
        const token = document.getElementById("token").value.trim();
        const hubUrl = document.getElementById("hubUrl").value.trim();

        if (!token) {
          alert("Vui l√≤ng d√°n JWT tr∆∞·ªõc.");
          return;
        }

        if (connection) {
          await connection.stop();
        }

        connection = new signalR.HubConnectionBuilder()
          .withUrl(hubUrl, {
            accessTokenFactory: () => token,
          })
          .withAutomaticReconnect()
          .build();

        connection.on("notificationReceived", (notification) => {
          log(`üì¨ ${JSON.stringify(notification, null, 2)}`);
        });

        connection.onclose((error) => {
          setStatus(error ? "M·∫•t k·∫øt n·ªëi (error)" : "ƒê√£ ng·∫Øt k·∫øt n·ªëi", !!error);
          disconnectBtn.disabled = true;
          connectBtn.disabled = false;
          if (error) {
            log(`‚ö†Ô∏è ${error}`);
          }
        });

        try {
          await connection.start();
          setStatus("ƒêang l·∫Øng nghe realtime...");
          log("‚úÖ ƒê√£ k·∫øt n·ªëi, ch·ªù th√¥ng b√°o...");
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
        } catch (err) {
          setStatus("K·∫øt n·ªëi th·∫•t b·∫°i", true);
          log(`‚ùå ${err}`);
        }
      });

      disconnectBtn.addEventListener("click", async () => {
        if (connection) {
          await connection.stop();
          connection = null;
          setStatus("ƒê√£ ng·∫Øt k·∫øt n·ªëi");
          log("‚õî ƒê√£ ng·∫Øt k·∫øt n·ªëi.");
          disconnectBtn.disabled = true;
          connectBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
